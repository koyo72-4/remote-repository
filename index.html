<!DOCTYPE html>
<html>
<head>
  <style>
    #theMap {
      float: left;
    }
    #div {
      float: left;
      margin-left: 20px;
      width: 40%;
    }
  </style>
</head>
<body>
 
  <iframe id="theMap"
  title="Inline Frame Example"
  width="50%"
  height="400">
</iframe>
<div id="div">
  <h1>Burlington Restaurants</h1>
</div>
<!-- <div id="mapdiv"></div> -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
   integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
   crossorigin=""/>
   <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
   integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
   crossorigin=""></script>
<script src="http://www.openlayers.org/api/OpenLayers.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
let params = new URLSearchParams(document.location.search.slice(1));
let name = params.get("name");

let mapUrl = "https://nominatim.openstreetmap.org/search/";
let cityAndState = ",Burlington,VT";

let div = document.getElementById("div");


if (params.has("name")){

fetch(name + '.json')
.then(function(response) {
  return response.json();
})
.then(function(restaurantInfo) {
  console.log(restaurantInfo);
  
  let restaurantName = document.createElement('p');
  restaurantName.textContent = restaurantInfo.name;
  div.appendChild(restaurantName);
  
  let restaurantAddress = document.createElement('p');
  restaurantAddress.textContent = "Address: " + restaurantInfo.address;
  div.appendChild(restaurantAddress);
  
  let restaurantPhoneNumber = document.createElement('p');
  restaurantPhoneNumber.textContent = "Phone Number: " + restaurantInfo["phone number"];
  div.appendChild(restaurantPhoneNumber);

  let restaurantHours = document.createElement('p');
  restaurantHours.textContent = "Hours: " + restaurantInfo.hours;
  div.appendChild(restaurantHours);

  let restaurantComments = document.createElement('p');
  restaurantComments.textContent = "Notes:";
  div.appendChild(restaurantComments);
  for (let i = 0; i < restaurantInfo.notes.length; i++) {
    let para = document.createElement('p');
    para.innerHTML = marked(restaurantInfo.notes[i]);
    div.appendChild(para);
  }

  let home = document.createElement('p');
  let homeLink = document.createElement('a');
  homeLink.setAttribute('href', '/');
  homeLink.textContent = "Back to restaurants list"
  home.appendChild(homeLink);
  div.appendChild(home);

  return restaurantInfo;
})

.then(function(restaurantInfo) {
  let spaceRegex = /\s/g;
  let urlApi = "https://nominatim.openstreetmap.org/search/?q=";
  let urlAddress = restaurantInfo.address.replace(spaceRegex, "%20");
  let iframe = document.getElementById("theMap")


  fetch(urlApi + urlAddress + "Burlington,VT" + "&format=json")
  .then(function(response) {
    console.log(response.json)
    return response.json();

  })
  .then(function(restaurantMap){
    console.log(restaurantMap)
    console.log(restaurantMap[0].boundingbox)
    let iframe = document.getElementById("theMap")
    let left = restaurantMap[0].boundingbox[0]
    let bottom = restaurantMap[0].boundingbox[1]
    let right = restaurantMap[0].boundingbox[2]
    let top = restaurantMap[0].boundingbox[3]
    iframe.setAttribute("src","https://www.openstreetmap.org/export/embed.html?bbox=" + right + "," + bottom + "," + top + "," + left + "&layer=mapnik")

  });
});
  let mapdiv = document.getElementById("mapdiv")
  mapdiv.style.display = "none";

} else {

  let restaurantIdsArray = ["red-onion", "mr-mikes", "asiana-noodle-house", "august-first", "church-street-tavern", "city-market", "new-moon"];

  for (let id of restaurantIdsArray) {
    fetch(id + '.json')
    .then(function(response) {
      return response.json();
    })
    .then(function(restaurantInfo) {
      console.log(restaurantInfo);
      let restaurantParagraph = document.createElement('p');
      let restaurantAnchor = document.createElement('a');
      if (restaurantInfo.name.includes("🍜")) {
        restaurantAnchor.textContent = restaurantInfo.name.substring(0, restaurantInfo.name.length - 2);
      } else {
        restaurantAnchor.textContent = restaurantInfo.name;
      }
      restaurantAnchor.setAttribute("href","/?name=" + id)
      restaurantParagraph.appendChild(restaurantAnchor);
      div.appendChild(restaurantParagraph);
    })
  }
  
  let iframe = document.getElementById("theMap");

  iframe.setAttribute("src", "mapmarker.html")
}

</script>
</body>
</html>